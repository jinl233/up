# 数据链路层概述

 - **链路(Link)**
  从一个结点到相邻结点的一段物理线路，而中间没有任何其他的交换结点
 - **数据链路(Data Link)**
  把实现通信协议的硬件和软件加到链路上，就构成了数据链路
 - 数据链路层以**帧**为单位传输和处理数据
 
 ### 三个重要问题

 ##### 封装成帧 

![图 43](../../images/92b453e7295f3cde6bd08275bdb7b63837adfbb582ad9958e3910e21dba662b9.png)  

 ##### 差错检测

- 帧在传输过程中遭遇干扰后可能会出现误码
- 在封装时将计算得出的检错码封装在帧尾
- 根据帧尾中的检错码检测帧中是否有误码
 
 ##### 可靠传输
 - 如果实现发送方发送什么，接收方就能收到什么，就称为可靠传输

--- 
# 封装成帧

-  封装成帧是数据链路层给上层交付的协议数据单元添加帧头和帧尾是之成为帧
     - 帧头和帧尾中包含重要的控制信息
  ![图 44](../../images/290a8d351f3a19269d89d0c6a90e6752799f315a03da40164c4dfa8e9f5296a7.png)  

     - 帧头和帧尾的作用之一就是**帧定界**（ppp有MAC没有）

- 透明传输是**数据链路层对上层交付的传输数据没有任何限制**，就好像数据链路层不存在一样
  - 面向字节的物理链路使用字节填充（字符填充）的方法实现透明传输
  - 面向比特的物理链路使用比特填充的方法实现透明传输
  ![图 45](../../images/49e2e64db452ad707b466655f225c0b7e8b9590b402f2248072a2a8380b5c0ef.png)  


 - 在上层交付的协议**数据单元中包含了帧定界字符**时：
   - 在发送帧之前对帧的数据部分进行扫描，每**出现一个帧定界符或转义字符**就在其前面插入一个转义字符

为提高帧是传输效率，应使**帧的数据部分的长度尽可能的大**
每一种数据链路层协议都规定了帧的数据部分的长度上限，即**最大传送单元MTU**


# 差错检测

### 比特差错
 实际的通信链路都不是理想的，比特在传输过程中可能产生差错：1变成0，0变成1
### 误码率
 一段时间内，传输错误的比特占传输比特总数的比率称为误码率
 
### 差错检测码
检测数据传输过程中是否产生了比特差错，是数据链路层要解决的重要问题之一

### 奇偶校验
![图 46](../../images/55eac0364eddd24f57e2f8b923d8cdaf72a0b5adb089790359c1a1ef38366b55.png)  

- 在待发送的数据后面**添加1位奇偶校验位**，使整个数据（包括所添加的校验位在内）中“1”的个数为奇数（奇校验）或偶数（偶校验）  
- 如果有**奇数个位发生误码**，则奇偶性发生变化，**可以检查出误码**  
- 如果有**偶数个位发生误码**，则奇偶性不发生变化，**不能检查出误码（漏检）**  

### 循环冗余校验CRC
- 双方约定好一个**生成多项式G**（x）    
- 发送方基于待发送的数据和生成多项式计算出差错检测码（**冗余码**），将其添加到待传输数据后面一起传输    
- 接收方通过生成多项式来计算收到的数据是否产生了误码  
<!-- ![图 47](../../images/4ae33908c8a58c17012088a8a2f1c3e9c525a8909303e5b8eff3b7cd6284f2bf.png)  

![图 48](../../images/c17da70059fd84e7bda92d5d9f0c70f81352af423f66c27a96cc3acbf5e2c0ba.png)   -->
![图 49](../../images/43bf964536d35eadd995ff680bc3addfec10cbb44a4230095b9d5b4842c5d228.png)  

- **算法要求生成多项式必须包含最低次项**   
- **检错码**只能检测出帧在传输过程中出现了差错，但不能定位错误，因此**无法纠正错误**  
- 要想纠正传输中的差错，可以使用冗余信息更多的**纠错码**进行**前向纠错**。但纠错码的开销比较大，在**计算机网络中较少使用**。
- 优点  
  - 漏检率非常低  
  - 易于用硬件实现  
  - 广泛应用于数据链路层  
 
  
# 可靠传输
## 可靠传输的基本概念

- 使用**差错检测技术**（循环校验CRC），接收端就可以检测帧在传输过程中是否产生了误码

- 数据链路层向上层提供的服务类型  
  - **可靠传输服务**：实现发送端**发什么，接收端收什么**  
  - **不可靠传输服务**：**仅丢弃有误码的帧**  


- 一般情况下，**有线链路**的误码率比较低，为了减小开销，并**不要求数据链路层**向上提供**可靠**传输服务。即使出现了误码，可靠传输的问题由其上层处理  

- **无线链路**易受干扰，误码率比较高，因此**要求数据链路层**必须向上层提供**可靠**传输服务
- **比特差错**只是传输差错中的一种


- 从整个计算机网络体系结构来看，传输差错还包括**分组丢失**、**分组失序**以及**分组重复**
- 可靠传输服务并不仅局限于数据链路层，其他各层均可选择实现可靠传输
  ![图 50](../../images/c2abd321eeebaa27c046e0b6250402f1b180ae338847281182cb48020c98a2ca.png)  



<!-- 
使用差错检测技术（循环校验CRC），接收端就可以检测帧在传输过程中是否产生了误码

- 传输差错   
  - 分组丢失  
  - 分组失序  
  - 分组重复  
- 以上差错一般不出现在数据链路层，而是其上层  
- 可靠传输服务不局限于数据链路层，其他各层均可选择实现可靠传输  
 ![图 6](../../images/c0fd96a10cfe7e6fc0d936ec82da05800fa0675ec108857125a0c180ca8f57d9.png)   -->


  
## 可靠传输的实现机制
### 停止-等待协议SW(**S**top-and-**W**ait)

###### 正常情况与发送方数据丢失重传
  ![图 52](../../images/1eb1a8dd12c7ec7e9cb034fe14564cb2451188aa8a88bf3bccc4054b65832ab7.png)  
  - 接收方收不到数据分组，就不会发送ACK或NAK。如果不采取其他措施，发送方就会一直处于等待接收方ACK或NAK的状态
  - 为解决该问题，可以在发送方发送完一个数据分组时启动一个**超时计时器**。若到了超时计时器所设置的**重传时间**而发送方仍收不到接收方的任何ACK或NAK,则重传原来的数据分组，这就叫做**超时重传**
  - 一般可将重传时间选为略大于“从发送方到接收方的平均往返时间”

###### 接收方确认信息丢失重传
![图 53](../../images/d182175e43ab4fbfb1b6eb782e10766dcc4648d51db27d6654f833a1a88e4039.png)  

- 为避免分组重复这种传输错误，必须给每个分组带上序号  
- 对于停止等待协议，由于每发送一个数据分组就停止等待只要保证每发送一个新的数据分组，其发送序号与上次发送的数据分组的序号不同就可以了，因此用一个比特来编号就够了  

###### 接收方确认信息超时重传
![图 54](../../images/0d0885914f62b5c03eca453edcb0b10a29bb622846fc86d266dfed98d657691e.png)  

> [! todo]- 注意事项
> - 接收端检测到数据分组有误码时，将其丢弃并等待发送方的超时重传。但对于误码率较高的点对点链路，为使发送方**尽早重传**，也可**给发送方发送NAK分组**  
> - 为了让接收方能够判断所收到的数据分组是否是重复的，需要给**数据分组编号**。由于停止等待协议的停等特性，**只需1个比特编号就够了**，即编号0和1  
> - 为了让发送方能够判断所收到的ACK分组是否是重复的，需要给**ACK分组编号**，所用比特数量**与数据分组编号所用比特数量一样**。数据链路层一般不会出现ACK分组迟到的情况，因此在**数据链路层实现停止-等待协议可以不用给ACK分组编号**  
> - 超时计时器设置的**重传时间**应仔细选择。一般可将重传时间选为**略大于“从发送方到接收方的平均往返时间”**  
>    - 在数据链路层点对点的往返时间比较确定，重传时间比较好设定  
>    - 然而在运输层，由于端到端往返时间非常不确定，设置合适的重传时间有时并不容易  




###### 信道利用率

$$U=\frac{T_D}{T_D+RTT+T_A}$$
![图 55](../../images/8ddc8003b83a3ce9243b58c970424739fe9f62bdaf404161f68380e29d5d508f.png)  

> [! cite]- 例如
> 假设信道长度2000km,数据分组长度1500B,发送速率10Mbit/s。(忽略TA,因为TA一般都远小于TD)
> $\Large U\approx\frac{T_{D}}{T_{D}+RTT}=\frac{\frac{1500*8 bit}{10*10^6 bit /s}}{\frac{1500*8 bit}{10*10^6 bit /s} + \frac{2000 *10^3 bit}{2*10^8 m/s}}\approx5.66\%$  
>   
> 若提高发送速率到100Mb/s  
> $\Large U\approx\frac{T_{D}}{T_{D}+RTT}=\frac{\frac{1500*8 bit}{100*10^6 bit /s}}{\frac{1500*8 bit}{100*10^6 bit /s} + \frac{2000 *10^3 bit}{2*10^8 m/s}}\approx 0.6\%$

- 当往返时延RTT远大于数据帧发送时延TD时（例如使用卫星链路），信道利用率非常低  
- 若出现重传，则对于传送有用的数据信息来说，信道利用率还要降低  
- 为了克服停止-等待协议信道利用率很低的缺点，就产生了另外两种协议，即后退N帧协议GBN和选择重传协议SR

### 回退N帧协议GBN(**G**o-**B**ack-**N**)`要考`
![图 58](../../images/a9df612e17adc839a0864adc49dc51a9e394377cf8251e07ca3de2002f4df92c.png)  

###### 无差错
1. 采用3个比特给分组编序号，即序号0~7  
2. 发送窗口的尺寸$W_T$的取值：$1 < W_T \le 2^3-1$，本例取$W_T$=5
3. 接收窗口的尺寸WR的取值：$W_R$=1
![图 56](../../images/d7dbcd075bbeb248d8e2b10a5f2be9badad96eb95c424efa9462df92fef98fd1.png)  

###### 累积确认
- 接收方**不一定**要对收到的数据分组**逐个发送确认**，而是可以在收到几个数据分组后（由具体实现决定）**对按序到达的最后一个数据分组发送确认**。ACKn表示序号为及以前的所有数据分组都已正确接收

> 即使确认分组丢失，发送方也可能不必重传

###### 有差错
![图 57](../../images/85f3e2d80d58d1f5c0a75d278bc86128a0b1820ea00c0f64abccc8a7634a1519.png)  

- 发送方收到重复的确认，就知道之前所发送的数据分组出现了差错，于是可以不等超时计时器超时就立刻重传！  
- 至手收到几个重复确认就立刻重传，由具体实现决定  
- 在本例中，尽管序号为6,7,0,1的数据分组正确到达接收方，但由于5号数据分组误码不被接受，它们也“受到牵连”而不被接受，发送方还要重传这些数据分组，这就是所谓的Go-back-N(回退N顺)  

> 接收方无法分辨新、旧数据分组

### 选择重传协议SR`要考`
![图 60](../../images/4479b9c6a12fd0fb31a40e3bcdddc6f97a00fa90b32525c9703fffeddd3d00eb.png)  


1. 采用3个比特给分组编序号，即序号0~7  
2. 发送窗口的尺寸$W_T$的取值：$1 < W_T \le 2^3-1$，本例取$W_T$=5
3. 接收窗口的尺寸WR的取值：$W_R=W_T=4$
![图 59](../../images/7d100d1dd996b274c5c58f22d7bb83c8a5f1710ffadb167ad96445b3b6e7de9a.png)  

 - 发送方的发送窗口尺寸$W_T$必须满足：$1 < W_T \le 2^{n-1}$ ，其中n是构成分组序号的比特数量
   - 若$W_T=1$：与停止-等待协议相同  
   - 若$W_T> 2^{n-1}$：造成接收方无法分辨新、旧数据分组的问题

- 接收方的接收窗口尺寸$W_R$必须满足：$1 < W_R \le W_T$
	- 若$W_R=1$:与回退N帧协议相同
	- 若$W_R > W_T$无意义


# 点对点协议ppp

是目前使用最广泛的点对点数据链路层协议 **(提供不可靠传输服务)**

PPP协议为在点对点链路传输各种协议数据报提供了一个标准方法：

|                            |                                      |
| :------------------------: | :----------------------------------: |
| 对各种协议数据报的封装方法 |               封装成帧               |
|      链路控制协议LCP       | 用于建立、配置以及测试数据链路的连接 |
|    一套网络控制协议NCPs    | 其中的每一个协议支持不同的网络层协议 |



 ![图 7](../../images/70496352720feb38146c95dd5f0c9d4b4031c94c4c893b2c23b96cec09345a39.png)  

 
 
### 帧格式
![图 64](../../images/0a35827339363cc3e6ca56664e2d270fe5dbf6e84b5f7dc5fab3b3b93b733e95.png)  

- 标志(**F**lag)字段：PPP帧的定界符，取值为0x7E
- 地址(**A**ddress)字段：取值为OxFF,预留（目前没有什么作用）
- 控制(**C**ontrol)字段：取值为0x03,预留（目前没有什么作用）
- 协议(**P**rotocol)字段：指明帧的数据部分送交哪个协议处理
- 帧检验序列(**F**rame **C**heck **S**equence)字段：CRC计算出的校验位

|  取值  |   协议   |                                            格式                                             |
| :----: | :------: | :-----------------------------------------------------------------------------------------: |
| 0x0021 | IP数据报 | ![图 61](../../images/cd8b7b79e106b7566d4eacafa50a04a3a9c535ef1937a6e35d35231adec7795f.png) |
| 0xC021 | LCP分组  | ![图 62](../../images/df9df6f5b8b589ba51d1fe04b619d8fe41350feacce9726b0620cb7de967985f.png) |
| 0x8021 | NCP分组  | ![图 63](../../images/800ee4409ca9bfc8505f2ad91293b79e42b443c4586f738344f9003d9e8010dc.png) |

### 透明传输



##### 面向字节的异步链路

字节填充法:插入转义字符

   ![图 9](../../images/79a97e3052ea073e1bdb48229f27f5f44e1b62729ffd0a8727bbc454af0bb7b7.png) 
- . 发送方   
    - 出现的每一个**7E**（PPP帧的定界符）字节转变为2字节序列 **(7D，5E)**    
    - 出现的每一个**7D**（转义字符）字节转变为2字节序列 **（7D，5D）**  
    - 出现的每一个ASCLL码控制字符（**数值小于0x20的字符**），则在该字符前插入一个7D字节，同时将该字符的编码**加上0x20**  
- . 接收方  
  - 进行反变换即可  

 ##### 面向比特的同步链路
 比特填充法:插入比特0

![图 65](../../images/5365a67ec857aa8876470e8d34672f9390b4386644adf5875506af8fd949b97e.png)  

- . 发送方  
  - 对帧的数据部分进行扫描   
  - 只要发现**五个连续的比特1**，则立刻**填充1个比特0**   
- . 接收方  
   - 对帧的数据部分进行扫描   
   - 只要发现**五个连续的比特1**，则立刻**删除1个比特0**  

### 差错检测 `要考`

 ![图 66](../../images/3302d6dd1d596ced03a7e0302505ffa39266423c204ad276f08bd22d6833cdde.png)  

$CRC-CCITT=X^{l6}+X^{l2}+X^{5}+1$ 
- 接收方每收到一个PPP帧，就进行CRC检验。若CRC检验正确，就收下这个帧；反之，就丢弃这个帧。使用PPP的数据链路层**向上不提供可靠传输服务**   

### 工作状态
![图 67](../../images/786c7fdf2d2e576619ae3b3b9a7ba7f8260ecce51149fa6ff479d1e3c8d16fcc.png)  


# 媒体接入控制
## 媒体接入控制的基本概念

共享信道要着重考虑的一个问题是：如何协调多个发送和接收站点对一个共享传输媒体的占用，即**媒体接入控制MAC**
```mermaid
graph LR
    媒体接入控制-->静态划分信道;
    媒体接入控制-->动态接入控制;
    静态划分信道-->频分多址;
    静态划分信道-->时分多址;
    静态划分信道-->码分多址;
    动态接入控制-->受控接入;
    动态接入控制-->随机接入;
    受控接入-->集中控制;
    受控接入-->分散控制;
```

<!-- ### 媒体接入控制 `要考` -->
- . 静态划分信道
  - 预先固定分配好信道，非常不灵活，对于冲突性数据传输信道利用率会很低
  - 通常在无线网络的物理层中使用


- . 动态接入控制
  - 受控接入
    - 集中控制
      - 有一个主站以循环方式轮询每个站点有无数据发送，只有被问到的站点才能发送数据
    - 分散控制
      - 各站点平等，连接成环形网络，令牌（特殊帧）沿环形站传递，接收到令牌才能发送数据，井在发送完数据后将令牌传递给下一个站点  
  - 随机接入
    - 所有站点通过竟争，随机地在信道上发送数据。如果恰巧有两个或更多的站点在同一时刻发送数据，则信号在共享媒体上就要产生碰撞（即发生了冲突）。使得这些站点的发送都失败。因此，这类协议要解决的关键问题是如何尽量避免冲突及在发生冲突后如何尽快恢复通信。著名的共享式以太网采用的就是随机接入

> [!DANGER] 随着技术的发展，交换技术的成熟和成本的降低，具有更高性能的使用点对点链路和链路层交换机的交换式局域网在有线领域已完全取代了共享式局域网，但由于无线信道的广播天性，无线局域网仍然使用的是共享媒体技术


## 静态划分信道


### 信道复用
- . 复用：通过一条物理线路同时传输多路用户信号
- 当网络中传输媒体的传输容量大于多条单一信道传输的总通信量时，可利用复用技术在一条物理线路上建立多条通信信道来充分利用传输媒体的带宽


![图 68](../../images/83937280e2423ef2a0ac83965e0ac0e33ff058fc38179e142f697d562e507586.png)  


 #### 频分复用FDM

![图 69](../../images/2bac0107e0540e31cdb18e66307eae92caa22dea2517b85a36d702464b76e61f.png)  


   **将传输线路的频带资源划分成多个子频带，形成多个子信道，各子信道之间需要留出隔离频带，以免造成子信道干扰**
 - 当多路信号输入一个多路复用器时  
   复用器将每路信号调制到不同频率的载波上  
 - 接收端接收时  
   由相应的分用器通过滤波将各路信号分开，将合成的复用信号恢复成原始的多路信号  
  
> **频分复用的所有用户同时占用不同的频带资源并进行通信**
 
 
 #### 时分复用TDM

![图 70](../../images/b9f5d6ae660fda1411f124e77170ae5266af87379807ee03d5f183750f0033ca.png)  


- **把时间划分为时隙，TDM将传输线路的宽带资源按时隙轮流分配给不同的用户，每对用户只在分配的时隙里使用线路传输数据**


- 时分复用技术将时间划分成了一段段等长的时分复用帧，每个时分复用的用户在每个时分复用帧中占用固定序号的时隙,==每个用户占用的时隙是周期性出现的== ,其周期就是时分复用帧的长度

> 时分复用的所有用户在不同的时间占用同样的频带宽度
 #### 波分复用WDM
![图 71](../../images/dd7bca01c9d3e3a6ca4e7baf40a5a6e94e7ad808c016e69d46bd8d6e951d453a.png)  

   
#### 码分复用CDM 
- 该技术用于多址接入，常用名词：码分多址CDMA
- 频分复用FDM和时分复用TDM同样可用于多址接入，对应的名词是频分多址FDMA和时分多址TDMA

###### 复用和多址
- 复用是将单一媒体的频带资源划分成很多子信道，这些子信道之间相互独立，互不干扰。 从整体频带资源上看，每个子信道只占用该媒体频带资源的一部分
- 多址（多点接入）处理的是动态分配信道给用户。这在用户仅暂时占用信道的应用中是必须的，而所有的移动通信系统基本都属于这种情况。相反在信道永久性地分配给用户的应用中，多址是不需要的（无线广播、电视广播站）。

--- 

- 某种程度上，FDMA、TDMA、CDMA可用看成FDM、TDM、CDM的应用   
- 于FDM和TDM不同，CDM的每一个用户可以在**同样的时间使用同样的频带进行通信**


- 由于**各用户使用经过挑选的不同码型**，因此各用户之间**不会造成干扰**    

- 这种系统发送的信号有很强的抗干扰能力，频谱类似于白噪声，最初为军事通信，价格和体积大幅度下降后广泛用于民用的移动通信
   
--- 

- 在CDMA中，每一个比特时间再划分为m个短的时隙，称为**码片**。通常m的值为64或128  （后面假设为8）
   
- 使用CDMA的每一个站被指派唯一的**m bit码片序列**
  如果发送**比特1**，则发送它自己的**m bit 码片序列**
  如果发送**比特0**，则发送他自己的**m bit码片序列的二进制反码**

> [!EXAMPLE]- 直接序列扩频 DSSS  
>   
> 某个站点的码片序列0001 1011  
> 发送比特1：0001 1011  
> 发送比特0：1110 0100  
> 将0写为-1，1写为+1  
> 站点的码片序列：（`-1-1-1+1`   `+1-1+1+1`）

  
--- 

- . 挑选原则
  -  分配给每个站的**码片序列必须各不相同，实际常采用伪随机码序列**
  -  分配给每个站的**码片序列必须相互正交**（规格化内积为0）
     -  令向量S表示站S的码片序列，令向量T表示其他任何站的码片序列。  
      - 两个不同站的码片序列正交，就是向量S和T的规格化内积为0 $$S·T\equiv \frac{1}{m}  \sum_{i=1}^m S_i T_i = 0$$
      $$S·S\equiv \frac{1}{m} \sum_{i=1}^m S_i S_i \\   = \frac{1}{m} \sum_{i=1}^m (\pm1)^2 = 1$$ 
      - **任何一个码片向量和其他各站码片反码的向量内积也是0**  
  $$S·\bar{T}\equiv  0$$
      - **任何一个码片向量和其该码片反码的向量内积也是-1**  
   $$S·\bar{S}\equiv  0$$  
  <!-- $$S·S\equiv \frac{1}{m} \sum_{i=1}^m S_i S_i = \frac{1}{m} \sum_{i=1}^m (\pm1)^2 = 1$$
  $$S·\bar{T}\equiv  0$$
   $$S·\bar{S}\equiv  0$$ -->



> [!QUESTION]- Question
![图 72](../../images/535694cd334f6854bea208b321aaae921b9ff19b9b83062df94922d5f4273c10.png)  

###### 应用和举例
![图 73](../../images/690ffff4e63fedd44bf7c3b6287a5a779cfbeff24872c2d77fd1fc1fe94caa0e.png)  

--- 
## 随机接入—CSMA/CD协议  `要考要考`

> **载波监听** ==多址接入==/碰撞检测   
> **CS** ==MA==—CD  
> (**Carrier Sense** ==Multiple Access== /Collision Detection)


##### 多址接入MA
- . 多个站连接再一条总线上，竞争使用总线
##### 载波监听CS
- . 每个站再发送帧之前先要检测总线上是否有其他站点再发送帧("先听后说")   
  - 若检测到总线空闲96比特时间，则发送这个帧  
  - 若检测到总线忙，则继续检测并等待总线转为空闲96比特时间，然后发送这个帧  
- . 96比特时间  
    - 发送96比特所耗费的时间，也称为帧间最小间隔  
    - 使接收方检测出一个帧的结束，也使其他站点公平竞争信道并发送帧
  


##### 碰撞检测CD
- . 每一个发送帧的站边发送边检测碰撞("边听边说")
  - 一旦发现总线上出现碰撞，退避一段随机时间后再次发送("一旦冲突，立即停说，等待时机，重新再说")


##### 实例
   主机C使用总线发送帧的过程中，B也要发送帧
![图 74](../../images/182046d84455003c01cf097c3c713b4abb5fd2d34236b07db8b24e9366c965e0.png)  


- **强化碰撞措施**
 当发送帧的站点一旦检测到碰撞，立即停止发送帧后继续发送**32或48比特的人为干扰信号**，以便**有足够多的碰撞信号使足够多的站点都能检测出碰撞**  

 
 ### 争用期（碰撞窗口）：要考要补充

![图 75](../../images/7475498ab0765162684b39507a331c0e8cb301e34eedc359654e929471917ee4.png)  
 
- 主机最多经过2τ（即δ→0）的时长就可检测到本次发送是否遭受了碰撞
  
- 以太网的端到端往返传播使用2τ为**争用期**或**碰撞窗口**
  
- 经过争用期这段时间还没有检测出碰撞，才能肯定这次发送不会发生碰撞
  
- 每一个主机再自己发送帧之后的一小段时间内，存在遭遇碰撞的可能性。这一段时间使不确定的，它取决于另一个发送帧的主机到本主机的距离，但不会超过总线的端到端往返传播时延，即一个争用期时间。
  
- 在以太网中发送帧的主机越多，端到端往返传播时延越大，发生碰撞的概率就越大。因此**共享式以太网不能连接太多的主机，使用的总线也不能太长**
   - 10Mb/s以太网把争用期定为512比特发送时间，即51.2μs，因此其总线长度不能超过5120m，但考虑到信号衰减等，以太网规定总线长度不能超过2500m

 ### 最小帧长  `要考`
  ![图 76](../../images/0c9000e41cde186eb9dd036c30835acb3e142b688f43322b039159c651dadc69.png)  


- . 以太网规定**最小帧长为64字节**，即512比特，数据载荷最小帧长46字节(12比特即为争用期)  
  - 如果发送的数据非常少，需要填充字节使帧不小于64字节  
- . 以太网的**最小帧确保主机可在帧发送完成之前就检测到该帧的发送过程中是否遭遇了碰撞**  
  - 如果在争用期(共发送64字节)没有检测到碰撞，那么后续发送的数据就一定不会发生碰撞
  - 如果在争用期内检测到碰撞，就立即中止发送，这时已经发送出去的数据一定小于64字节，因此**长度小于64字节的帧都是由于碰撞而异常中止的无效帧**   x
 ### 最大帧长：要考
![图 77](../../images/e71ead713523e2911c8c0f5fc8b99636b431ee7e060592faa5f5d311888b2380.png)  


 ### 截断二进制指数退避算法  `要考`
 ![图 80](../../images/4b1e33f2b68b3bcb4edbf4b9cb9357a421e63982110221bb4c267c6fb4ec4b58.png)  


- 若连续多次发送碰撞，就表明可能有较多的主机参与竞争信道，但上述退避算法可**使重传需要推迟的平均时间随重传次数而增大（动态退避）**，因而**减小发生碰撞的概率**，有利于整个系统的稳定
- **当重传达16次仍不能成功时**，表明同时打算发送帧的主机太多，以至于连续发生碰撞，则**丢弃该帧**，并向高层报告

 ### 信道利用率：要考
![图 81](../../images/c31e85e3c566cf39e27f0ff971371b58a7d6961e46bcb4ada1cf0613e1570a04.png)  


- . 在理想情况下：
  - 各主机发送帧都不会产生碰撞   
  - 总线一旦空闲就有某个主机立即发送帧   
  - 发送一帧占用总线的时间为$T_0 + \tau$，而帧本身的发送时间是$T_0$  
    极限信道利用率$S_{max}=\frac{T_0}{T_0 + \tau}=\frac{1}{1+\frac{\tau}{T_0}}$  
  $(将\frac{\tau}{T_0}记为a)S_{max}=\frac{1}{1+a}$  
  参数a尽量小，以提高信道利用率  
   $\tau$应该尽量小→以太网端到端的距离应受到限制，不应太长  
   $T_0$应尽量大→以太网帧的长度尽量长
 
 ### 帧发送流程：要考
![图 83](../../images/1997b685a619733778302f00c1c58bd2c85a187968176f3c2b1404392b7dcec6.png)  




 ### 帧接收流程：要考
 ![图 84](../../images/725ff738ba6600a1e4b43b087853f6bd02c4619cf2ff4c0349b088007f70f80b.png)  






## 随机接入—CSMA/CA协议  `要考`

- **在无线局域网中可使用载波监听多址接入CSMA**，即在发送帧之前先对传输媒体进行载波监听，若发现有其他站在发送帧，就推迟发送以免发送碰撞  
 
- **在无线局域网不能使用碰撞检测CD**  
   - 由于无线信道的传输条件特殊，其信号强度的动态范围非常大，无线网卡上接收到的信号强度远小于发送信号的强度（差百万倍）。**如果在无线网卡上实现碰撞检测CD，对硬件的要求非常高**  
   - 即使能在硬件上实现，由于无线电波传播的特殊性（**存在隐蔽站问题，进行检测的意义不大**）要考

![图 85](../../images/47ca6b6702c124277b14aeb7bbc32591497f1321740936d6dd0b004820da9609.png)  
1. A和C都检测不到对方的无线信号  
2. A和C都给B发送帧时，产生碰撞  
3. A和C无法检测到碰撞   


### 802.11无线局域网：要考
- 使用CSMA/CA协议，在CSMA的基础上增加了一个**碰撞避免CA功能**，而不再实现碰撞检测功能
- 由于**不可能避免所有的碰撞**，并且**无线信道误码率较高**，802.11标准还使用了**数据链路层确认机制（停止-等待协议）**来保证数据被正确接收
- 802.11的MAC层标准定义了两种不同的媒体接入控制方式
  - . 分布式协调功能DCF  
    - 没有中心控制站点，每个站点使用CSMA/CA协议通过争用信道获取发送权（默认）
  - . 点协调功能PCF  
    - 使用集中控制的接入算法（在接入点AP实现集中控制），是802.11定义的可选方式（实际较少使用）


### 帧间间隔IFS(InterFrame Space)

- 标准规定所有站点**持续检测信道空闲一段时间**才能发送帧，称为：**帧间间隔IFS**


- IFS长度取决于发送帧的类型  
  - 高优先级:  需要等待的时间较短，因此可优先获得发送权
  - 低优先级: 需要等待的时间较长。若某个站的低优先级帧还没来得及发送，而其他站的高优先级帧已发送到信道上，则信道变为忙态，因而低优先级帧就只能再推迟发送了。这样就减少了发生碰撞的机会  
- 两种常用帧间间隔  
  - **短帧间间隔**（28μs）  
    用来分隔开属于一次对话的各帧。一个站点应当能够在这段时间内从发送方式切换到接收方式。使用SIFS的帧类型有ACK帧、CTS帧、由过长的MAC帧分片后的数据帧、以及所有回答AP探询的帧和在PCF方式中接入点AP发送出的任何帧 
  - **DCF帧间间隔**（128μs）   
    比短帧间间隔SFS要长得多，在DCF方式中用来发送数据帧和管理帧

### 工作原理
![工作原理](../../images/13f682f1ba7b5772042bfc0c40086b0f87ce0bee3d56667ad031149073b9b851.png)  

 - 当信道是空闲时，且发送的数据帧不是成功发送完上一个数据帧之后立即连续 发送的数据帧，则不使用退避算法
- 以下情况必须使用退避算法：
   - 发送数据帧之前信道在忙状态
   - 重传数据帧
   - 成功发送完上一个数据帧之后连续发送下一个数据帧（避免一个站长时间占用信道）

 

<!-- ![图 28](../../images/702134b48e0684004a0edd9c079ac9b28d5bd46c611157c59d99a9345af1dcfb.png)   -->



### 退避算法

- 在执行退避算法时，站点为退避计时器设置一个随机的退避时间  
	- 当退避计时器的时间减小到零时，就开始发送数据  
	- 当退避计时器的时间还未减小到零时而信道又转变为忙状态，这时就冻结退避计时器的数值，重新等待信道变为空闲，再经过时间DFS后，继续启动退避计时器  
- 在进行第次退避时，退避时间在时隙编号$\{0,1,…，2^{2+i}-1\}$中随机选择一个，然后乘以基本退避时间（也就是一个时隙的长度）就可以得到随机的退避时间。这样做是为了使不同站点选择相同退避时间的概率减少。当时隙编号达到255时（对应于第6次退避）就不再增加了  

![图 87](../../images/130935947eb4fc9fab4f2f1350a3495ee69a67f9ecc1809670675b2eefb845b6.png)  

  <!-- ![图 27](../../images/702134b48e0684004a0edd9c079ac9b28d5bd46c611157c59d99a9345af1dcfb.png)   -->

### 信道预约和虚拟载波监听
###### 信道预约
- 为了**减少碰撞的概率**，802.11标准允许发送数据的站点**对信道进行预约**
  - 源站在发送数据帧之前先发送一个短的控制帧，称为==请求发送RTS==(Request To Send),它包括源地址、目的地址以及这次通信（包括相应的确认帧）所需的持续时间    
  - 若目的站正确收到源站发来的RTS帧，且媒体空闲，就发送一个响应控制帧，称为==允许发送CTS==(Clear To Send),它也包括这次通信所需的持续时间(从RTS帧中将此持续时间复制到CTS帧中)     
  - 源站收到CTS帧后，再等待一段时间SIFS后，就可发送其数据帧     
  - 若目的站正确收到了源站发来的数据顿，在等待时间SIFS后，就向源站发送确认顿ACK  

> [!TIP]   RTS：请求发送,包括：源地址、目的地址、通信持续时间</p>  CTS：响应控制帧,包括：通信持续时间</p>  ACK：确认帧

<!-- ![图 26](../../images/ffb4c5cf51d90343f203b41d28c9d340f7efcfd2c326ad5066d3268970a4cdd3.png)   -->
![图 88](../../images/f974bf63261da8bff3d1504b2234697634487e0a167d1a048ef93162abcc672d.png)  

- 除源站和目的站以外的**其他各站**，在**收到CTS帧（或数据帧）后就推迟接入到无线局域网中**。这样就保证了源站和目的站之间的通信不会受到其他站的干扰。
- 如果RTS帧发生碰撞，源站就收不到CTS帧，需执行退避算法重传RTS帧。
- 由于**RTS帧和CTS帧很短，发送碰撞的概率、碰撞产生的开销及本身的开销都很小**。而对于一般的数据帧，其发送时延往往大于传播时延（因为是局域网），碰撞的概率很大，且一旦发生碰撞而导致数据帧重发，则浪费的时间就很多，因此**用很小的代价对信道进行预约往往是值得的**。802.11标准规定了3种情况供用户选择
	- 使用RTS帧和CTS帧
	- 不使用RTS帧和CTS顿
	- 只有当数据帧的长度超过某一数值时才使用RTS帧和CTS帧


###### 虚拟载波监听机制
- 除RTS顿和CTS帧会携带通信需要持续的时间，数据帧也能携带通信需要持续的时间，这称为802.11的**虚拟载波监听机制**  
- 由于利用虚拟载波监听机制，**站点只要监听到RTS帧、CTS帧或数据帧中的任何一个，就能知道信道被占用的持续时间**，而不需要真正监听到信道上的信号，因此**虚拟载波监听机制能减少隐蔽站带来的碰撞问题**  
    ![图 89](../../images/17e7d5d0a464d9d0c30e22426e8d6c9dcafd7051ffdad592d58c5ac7d58f9f52.png)  
    > c将知道信道被占用多长时间，a发送数据帧时不会受到干扰


  
  
# MAC地址、IP地址、ARP协议
<!-- ![图 25](../../images/c31fa9a49c38f6af85aea050f6aea5a11fa6b23802beea40940dfd96a73c89f3.png)   -->
> [!SUCCESS] 数据链路层
> MAC地址是以太网的MAC子层所使用的地址

> [!WARNING] 网际层
> IP地址是TCP/八P体系结构网际层所使用的地址
> 
>ARP协议属于TCP/IP体系结构的网际层，其作用是已知设备所分配到的1P地址，使用ARP协议可以通过该IP地址获取到设备的MAC地址


## MAC地址 `要考`

当多个主机连接在同一广播信道上，要实现两个主机间的通信，每个主机要有唯一的数据链路层地址  

每个主机发送的帧中必须携带标识发送主机和接收主机的地址，用于媒体接入控制，称为**MAC地址**  
   - MAC地址一般固化在网卡（网络适配器）中，也称为**硬件地址**  
   ![图 90](../../images/5411931475c06976fb7e6a29139b876d1c168c421914baeee6794216919e8252.png)  

   - windows也称物理地址（MAC**不属于物理层**）  

每个网络适配器都有全球唯一的MAC地址，而交换机和路由器有更多的网络接口也就是更多的MAC地址。**MAC地址是对网络上各接口的唯一标识，而不是对网络上各设备的唯一标识**
#### IEEE  802局域网的MAC地址格式

![图 91](../../images/4f177e3420fadfed8295f3f88e13b147e6e3c5a17e68aad8c5a13dca5f927f50.png)  

![图 92](../../images/df645b7961971525d671c78f68688082ec80b7b88467b5bbb26f9cbffc8d23bd.png)  


<!-- ![图 31](../../images/040e87402eb3e9feb5f397c4ee97d11bf98228211f085a12f98efb429bc2a866.png)  
![图 32](../../images/f793b92737c349f90ffdaa7939dcc96c819b2c980475abd43e6d1d50502ee67b.png)   -->

#### IEEE 802局域网的MAC地址发送顺序
字节发送顺序：第一字节$\rightarrow$第六字节
字节内的比特发送顺序：$b_0 \rightarrow b_7$

#### 单播MAC地址
![图 93](../../images/adfb0b9eb943249663420cc38294b85e73e3eaf19dac104be6397f345a8883ee.png)  

#### 广播MAC地址
![图 94](../../images/853a44462d4d19955d601df5dc2bab70aa4beb97abfea5c35723338d6f2adb5d.png)  

#### 多播MAC地址
![图 95](../../images/720bec03f18d1880e217fd6b14585826d6eb318e1694e4a9aac24cd040f1aa56.png)  


#### 随机MAC地址
  
## IP地址

- IP地址是因特网(Internet)上的主机和路由器所使用的地址，用于标识两部分信息  
	- **网络编号**：标识因特网上数以百万计的网络  
	- **主机编号**：标识同一网络上不同主机（或路由器各接口）  
- 很显然，之前介绍的MAC地址不具备区分不同网络的功能   
  - 如果只是一个单独的网络，不接入因特网，可以只使用MAC地址（这不是一般用户的应用方式）   
  - 如果主机所在的网络要接入因特网，则P地址和MAC地址都需要使用  
<!-- ![图 96](../../images/985b3565b8deaff24c8e5e86d558ea229e4a585bf5e0d1227ad93c248ccb62a1.png)   -->
##### 从网络体系结构看IP地址与MAC地址
![图 97](../../images/3b1b43ddb5136e05e7cd16bb94451880a1914b1cfd6ed3a24752daa54c89eede.png)  

##### 数据包转发过程中P地址与MAC地址的变化情况
![图 98](../../images/b065011027bbb4c4a9bb61c84e9fd10771dd317fbcacea56430d127dbe6b5acf.png)  
- 源P地址和目的P地址保持不变  
- 源MAC地址和目的MAC地址逐个链路（或逐个网络）改变  

## ARP协议
![图 0](../../images/2d139236d539a339a64e1e9a28e708b650fe9361a4ebc91f724dca39bdc166f4.png)  

- 源主机在自己的**ARP高速缓存表**中查找目的主机的1P地址所对应的MAC地址，若找到了，则可以封装MAC帧进行发送；若找不到，则发送**ARP请求(封装在广播MAC帧中)**  
- 目的主机收到ARP请求后，将源主机的P地址与MAC地址记录到自己的ARP高速缓存表中，然后给源主机发送ARP响应（封装在单播MAC帧中），ARP响应中包含有目的主机的IP地址和MAC地址  
- 源主机收到ARP响应后，将目的主机的IP地址与MAC地址记录到自己的ARP高速缓存表中，然后就可以封装之前想发送的MAC帧并发送给目的主机  
- A**RP的作用范围：逐段链路或逐个网络使用**  
- **除ARP请求和响应外，ARP还有其他类型的报文**（例如用于检查IP地址冲突的“无故ARP、免费ARP(Gratuitous ARP)”）  
- ARP没有安全验证机制，**存在ARP欺骗（攻击）问题**  



# 集线器和交换机


<!-- ### 集线器
##### 半双工
 使用双绞线和集线器HUB的星型以太网：
  ![图 33](../../images/cc8ea7ba4d43f7eff96e5176e9eb658bb8a95435a2f7886323ac41b9a36cdf62.png)  

  使用集线器的以太网在逻辑上仍然是一个总线网，各站共享总线资源，使用的还是CSMA/CD协议
  集线器只工作在物理层，只做简单的转发比特。碰撞检测由各站网卡检测
  集线器一般有少量的容错能力和网络管理能力（网卡出错集线器检测出来后从内部断开和故障网卡的连线，以太网仍然能正常工作）
 
 使用集线器HUB在物理层扩展以太网：
  ![图 34](../../images/906b67c7f644af8be2be19e5adc78f4abc5d8fb696def8f73394eae99c762dd2.png)  


 由集线器互连的主机之间发送单播帧会传输给总线上的各个主机
 由交换机互连的主机会直接转发给目的主机 -->


### 早期的总线型以太网
![图 1](../../images/8fc284b5316378a1f6089aefc23b0163676165c9807c6112b4a7260356c0c680.png)  

### 使用双绞线和集线器HUB的星型以太网
![图 2](../../images/721122233fbd1f0737106be8fa6d786a53fdefbb26fc6b3d6e2e464c11615b2c.png)  

- **使用集线器的以太网在逻辑上仍是一个总线网**，各站共享总线资源，使用的还是**CSMA/CD协议**    
- **集线器只工作在物理层**，它的每个接口仅简单地转发比特，不进行碰撞检测（由各站的网卡检测）  
- **集线器一般都有少量的容错能力和网络管理功能**。例如，若网络中某个网卡出了故障，不停地发送帧。此时，集线器可以检测到这个问题，在内部断开与出故障网卡的连线，使整个以太网仍然能正常工作  

### 使用集线器HUB在物理层扩展以太网
![图 3](../../images/7d63fa405e5b6c033e28d9a412ba26520d719b8f26a67504c1d4cb6e6fc41876.png)  

<!-- # 以太网交换机 -->
### 以太网交换机

![图 4](../../images/6dcbe4cb71d255bf1469bfab5048bc654d5e6219cc938862f9a8e85676357d83.png)  

- 以太网交换机通常都有**多个接口**。每个接口都可以直接与一台主机或另一个以太网交换机相连。一般都工作在**全双工方式**  
- 以太网交换机具有并行性，能同时连通多对接口，使多对主机能同时通信，**无碰撞(不使用CSMA/CD协议)**  
- 以太网交换机一般都具有多种速率的接口，例如：10Mb/s、100Mb/5、1Gb/s、10Gb/s接口的多种组合  
- 以太网交换机**工作在数据链路层**（也包括物理层），它收到帧后，在帧交换表中查找**帧的目的MAC地址所对应的接口号**，然后通过该接口转发帧  
- 以太网交换机是一种即插即用设备，其内部的**帧交换表**是通过自**学习算法**自动地逐渐建立起来的  
- 帧的两种转发方式  
  - **存储转发**  
  - **交换直通**：采用基于硬件的交叉矩阵（交换时延非常小，但不检查帧是否右差错）

### 对比

###### 集线器HUB
- 早期以太网的互连设备
- 工作在OS引体系结构的物理层
- 对接收到的信号进行放大、转发
- 使用集线器作为互连设备的以太网仍然属于共享总线式以太网。集线器互连起来的所有主机共享总线带宽，属于同一个碰撞域和广播域

###### 交换机SWITCH
- 目前以太网中使用最广泛的互连设备
- 工作在OS引体系结构的数据链路层（也包括物理层）
- 根据MAC地址对帧进行转发
- 使用交换机作为互连设备的以太网，称为交换式以太网。交换机可以根据MAC地址过滤帧，即隔离碰撞域。
- 交换机的每个接口是一个独立的碰撞域
- 交换机隔离碰撞域但不隔离广播域(VLAN除外)

![图 5](../../images/b98e0c610b5463a781c3e23240fcc620486211c603d6fb5491b55f9b601cf8a4.png)  


<!-- ##### 全双工
  ![图 35](../../images/e593f776574397d172c8dabc322d415690a8ff0ba4a3c5ed8befbcbcc562261e.png)   -->




# 以太网交换机自学习和转发帧的流程

- 以太网交换机工作在**数据链路层**（也包括物理层） 
- 以太网交换机收到帧后，在帧交换表中查找**帧的目的MAC地址所对应的接口号**，然后通过该接口转发帧  
- 以太网交换机是一种即插即用设备，刚上电启动时其内部的帧交换表是空的。随着网络中各主机间的通信，以太网交换机**通过自学习算法**自动逐渐**建立起帧交换表**  

相互连接的两台以太网交换机各自连接三台主机，构成交换式以太网

$A\rightarrow B$
<!-- ![图 36](../../images/257e214d095d96e136d30d80db46b5bec85aade54f723a420f2c6a9ccca13468.png)   -->
![图 6](../../images/559135bec735c72a5b0bf2e4ae0e38ede8809b66a12fcefaac4ed6c7ee1044a3.png)  

$B\rightarrow A$
<!-- ![图 37](../../images/f9f67be6313819d593d7b350fcd1181edbb75c32e4c925bcce797518591ac1f5.png)  
![图 38](../../images/0920620e3ba564b6499004cb8a7f3e71ecceb5273c8356938d2eb118f40f208e.png)   -->
![图 7](../../images/c13a61f98c63026f7c880113fab71b3a9539382aa722bd0adb6e6db1eadb8924.png)  

 
$E\rightarrow A$
<!-- ![图 39](../../images/d6b08c771f087df037894a2902262c7aa664e988ee130455668c44955e2699db.png)   -->
![图 8](../../images/0ec6fb5543f9356fa2a9bc0257608c4e7d5246d0c6a227c290d6c558a532edf6.png)  
###### 流程
- 收到帧后进行登记。登记的内容为帧的源MAC地址及进入交换机的接口号
- 根据帧的目的MAC地址和交换机的帧交换表对帧进行转发，有以下三种情况
  - 明确转发：交换机知道应当从哪个（或哪些）接口转发该帧(单播，多播，广播)
  - 盲目转发：交换机不知道应当从哪个端口转发帧，只能将其通过除进入交换机的接口外的其他所有接口转发（也称为泛洪）
  - 明确丢弃：交换机知道不应该转发该帧，将其丢弃

- 每条记录都有**有效时间**，到期自动删除，是因为**MAC地址于交换机接口的对应关系并不是永久性的**（更换主机或网卡）
 
# 以太网交换机的生成树协议STP

- 添加**冗余链路**可以提高以太网的可靠性。但是，冗余链路也会带来负面效应一形成**网络环路**  
- 网络环路会带来以下问题  
  - **广播风暴**  
    - 大量消耗网络资源，使得网络无法正常转发其他数据帧  
  ![图 9](../../images/d1e8b1bf5accf8654908857a11cb7918d1aff50e9e65cfef97881db9b5402ca2.png)  
  - **主机收到重复的广播帧**
  	- 大量消耗主机资源
  - **交换机的帧交换表震荡**(漂移)
    ![图 10](../../images/090897a7f7642b4f32ca40c5b3a7c5da37aa3ceb6ea3ab54cedfc9e2fa8acd9f.png)  
--- 

- 以太网交换机使用生成树协议STP(Spanning Tree Protocol),可以在增加冗余链路来提高网络可靠性的同时又避免网络环路带来的各种问题
  - 不论交换机之间采用怎样的物理连接，交换机都能够自动计算并构建一个逻辑上没有环路的网络，其逻辑拓扑结构必须是树型的（无逻辑环路）
  ![图 11](../../images/3f50b07a34dca3ecea27c6fc5ba9c354058cbc0e3edc1d5b8cb9780b6ad4ad78.png)  
  - 最终生成的树型逻辑拓扑要确保连通整个网络
  - 当首次连接交换机或网络物理拓扑发生变化时（有可能是人为改变或故障），交换机都将进行生成树的重新计算
  ![图 12](../../images/7b5ab5271b0e1bfeab0a7d0c3856ffea9be43a98f9586ff45625d9dda8519c92.png)  


# 虚拟局域网VLAN
 以太网交换机工作在**数据链路层（包括物理层）**
 使用一个或多个以太网交换机互连起来的交换式以太网都属于**同一个广播域**
- 巨大广播域的**弊端**  
  - 广播风暴
    - 广播风暴会浪费网络资源和各主机的CPU资源
 ![图 13](../../images/2f5eb2ab439f71983316e6138156ac81208ff7f366ecb6c85b6787340fbd124d.png)  
  - 难以维护和管理  
  - 潜在的安全问题  
###### 网络中会频繁出现广播信息
- TCP/IP协议栈中的很多协议都会使用广播  
  - 地址解析协议ARP (已知IP地址，找出其相应的MAC地址)   
  - 路由信息协议RIP（一种小型的内部路由协议）    
  - 动态主机配置协议DHCP (用于自动配置IP地址)  
- NetBEUI : Vidnows下使用的广播型协议  
- IPX/SPX : Novell网络的协议栈  
- Apple Talk : Apple公司的网络协议栈  



###### 分割广播域的方法  
- 使用路由器隔离  
  ![图 14](../../images/ee9d09f6861b9772882759cbcfd525640d7790b8d0c05e2e8258b5b2d4b0ea42.png)  
- 虚拟局域网VLAN  
  将局域网内设备**划分成与物理位置无关的逻辑组的技术，这些逻辑组具有某些共同的需求**
  ![图 15](../../images/b971a451083b8876dcba86a8c822e6b14ff5a3a8a396f1e8ad773fe6d00a3ee5.png)  



# 虚拟局域网VLAN实现机制

### IEEE802.1Q
- 对于以太网的MAC帧格式进行了扩展，插入了**4字节的VLAN标记**
![图 16](../../images/bb4bae1d35d6363875f1529d2c4ae330abd4d23398fccbef5ce4f498f7d79b69.png)  


- VLAN标记的**最后12比特**称为**VLAN标识符VID**，唯一标识了以太网帧属于哪一个VLAN
  - VID取值范围 $0  \thicksim 4095(0\thicksim 2^{12}-1)$  
  - $0$ 和 $4095$ 都不用来表示VLAN,因此用于表示VLAN的VID的有效取值范围是 $0  \thicksim 4094$
- **802.1Q帧是由交换机来处理的，而不是用户主机来处理的**  
  - 当交换机**收到普通的以太网帧**时，会将其插入4字节的VLAN标记转变为802.1Q帧，简称“**打标签**”  
  - 当交换机**转发802.1Q帧**时，**可能**会删除其4字节VLAN标记转变为普通以太网帧，简称“**去标签**”
 
 
 ### 交换机的端口类型
- 交换机各端口的缺省VLAN ID
  - 在思科交换机上称为Native VLAN,即本征VLAN
  - 在华为交换机上称为Port VLAN ID,即端口VLAN ID,简记为PVID


##### Access

- Access端口一般用于连接用户计算机
- Access端口只能属于一个VLAN
- Access端口的PVID值与端口所属VLAN的ID相同(默认为1)
- Access端口接收处理方法
	- 一般只接受“未打标签”的普通以太网MAC帧。根据接收帧的端口的PVID给帧“打标签”，即插入4字节VLAN标记字段，字段中的VID取值与端口的PVID取值相等。
- Access端口发送处理方法：
	- 若帧中的VID与端口的PVID相等，则“去标签”并转发该帧：否则不转发。

> [!SUCCESS]- 示例
![图 17](../../images/e821291838008878afa1eeb2825981e2d5345b5d43be37484b12177f3a6d17bf.png)  
![图 18](../../images/8e9f42c4329bf909d8e48b916c133b74e2cb4563d1e592a91428c3b49bc82905.png)  




##### Trunk

- Trunk端口一般用于交换机之间或交换机与路由器之间的互连  
- Trunk端口可以属于多个VLAN  
- 用户可以设置Trunk端口的PVID值。默认情况下，Trunk端口的PVID值为1  
- Trunk端口发送处理方法  
	- 对VID等于PVD的帧，“去标签”再转发  
	- 对VID不等于PVID的帧，直接转发  
- Trunk端口接收处理方法
	- 接收“未打标签”的帧，根据接收帧的端口的PVID给帧“打标签”，即插入4字节VLAN标记字段，字段中的VID取值与端口的PVID取值相等
	- 接收“已打标签的帧”  

> [!SUCCESS]- 示例
> 对VID等于PVD的帧:  
> ![图 19](../../images/ba644fff69b3cf957f8c68561ff4c0949ac4ce4b619454b4aae37e41b93b8ed2.png)  
> 对VID不等于PVID的帧:  
> ![图 20](../../images/0cab0f95285366bc4266e4529c94d9d945ef36ebb2253ec7f4843d30d76bdfea.png)  

##### Hybrid

- Hybrid端口既可用于交换机之间或交换机与路由器之间的互连(同Tunk端口)，也可用于交换机与用户计算机之间的互连(同Access端口)
- Hybrid端口可以属于多个VLAN(同Trun端口)
- 用户可以设置Hybrid端口的PVID值。默认情况下，Hybrid端口的PVID值为1(同Trun端口)
- . Hybrid端口发送处理方法(**与Trunk端口不同**)查看帧的VD是否在端口的“去标签”列表中
	- 若存在，则“去标签”后再转发
	- 若不存在，则直接转发
- Hybrid端口接收处理方法(同Trunki端口)
	- 接收“未打标签”的帧，根据接收帧的端口的PVID给帧“打标签”，即插入4字节VLAN标记字段，字段中的VID取值与端口的PVID取值相等
	- 接收“已打标签的顿”


> [!SUCCESS]- 应用举例
> 主机A、B、C连接在同一个交换机的不同接口上。利用Hybrid端口的功能，实现以下应用需求：A和B都能与C相互通信，但A与B不能相互通信
> ![图 21](../../images/ac5519dae8ed6a9efaf6156c578fcd30475251cde96ecbec910fcb51dab95899.png)  
> ![图 22](../../images/052281d7ffd99aed158fa11790803a168c376e46c1798c1242e94274674e3b01.png)  





