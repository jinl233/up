
## 虚拟存储器概述
第四章的存储器管理方式都要求将一个作业全部装入内存后方能运行，出现：
  (1) 作业太大，要求的内存空间超过了内存总容量，作业不能全部装入内存，使作业无法运行；
  (2) 有大量作业要求运行，但只能将少数作业装入内存让它们先运行，大量作业在外存上等待。


### 常规存储管理方式的特征和局部原理
1、常规存储器管理方式的特征
  前一章中所介绍的各种存储器管理方式统称为传统存储器管理方式，它们全都具有如下两个共同的特征：
  (1) 一次性：是指作业必须一次性地全部装入内存后方能开始运行。
  (2) 驻留性：作业驻留在内存中直到作业运行结束。
  
  可以看出：程序运行中不用或暂时不用的程序（数据）占据内存空间，而需要运行的作业又无法装入运行
2、局部性原理：在某一时间内，程序的执行仅局限于某个部分，故它所访问的存储空间也局限于某个区域。 
  (1) 时间局限性：指令和数据被多次使用，产生原因是循环操作。
  (2) 空间局限性：程序会访问某一范围的存储单元，如：顺序执行。
3、虚拟存储器的基本工作情况：应用程序在运行之前仅将当前需要的少数页或段先装入内存，其余留在盘上
  如果发生缺页则中断->调页->成功运行
  （若调页时内存已满则置换腾出空间，将请求的页调入内存）

### 虚拟存储器的定义和特征
1、虚拟存储器的定义：具有请求调入功能和置换功能，能从逻辑上对内存容量扩充的一种存储器系统。   逻辑容量由内存容量和外存容量之和所决定，运行速度接近内存，成本接近外存。
2.虚拟存储器的特征
特征：
  (1) 多次性：程序和数据可多次调入内存
  是虚拟存储器最重要的特征，可以认为虚拟存储器是具有多次性特征的存储器管理系统
  (2) 对换性：程序和数据可以根据状态在作业运行过程中换进、换出
  (3) 虚拟性：能够从逻辑上扩充内存容量，使用户所看到的内存容量远大于实际内存容量
虚拟性的基础是多次性和对换性


### 虚拟存储器的实现方法
1、分页请求系统：在分页系统的基础上增加了请求调页功能和页面置换功能， 只装入少数页面的程序（及数据）就启动运行，根据情况调入和调出。
  硬件支持：(1) 请求分页的页表机制
  (2) 缺页中断机构
  (3) 地址变换机构
  实现请求分页的软件：在硬件的支持下，将程序正在运行时所需的页面（尚未在内存中的）调入内存，再将内存中暂时不用的页面从内存置换到磁盘上。
2、请求分段系统：在分段系统的基础上，增加了请求调段及分段置换功能，允许用户程序只要装入少数段（而非所有的段）的程序和数据即可启动运行。
  硬件支持：(1) 请求分段的段表机制
  (2) 缺段中断机构
  (3) 地址变换机构
  软件支持



## 请求分页存储管理方式

### 请求分页中的硬件支持：要求一定容量的内存和外存、请求页表机制、缺页中断机构以及地址变换机构
  1、请求页表机制：主要的数据结构是：请求页表（将用户地址中逻辑地址 映射为 内存空间中的逻辑地址。
  
（1）状态位（存在位）P : 指示该页是否已调入内存，程序访问时参考。
（2）访问字段 A∶记录本页在一段时间内被访问的次数，或记录本页最近已有多长时间未被访问，置换算法（程序）在选择换出时参考。
（3）修改位 M∶标识该页调入后是否被修改过。若被修改过需要重新写入外存中，否则不需要。 提供置换页面时参考
（4）外存地址∶指出该页在外存上的地址（物理块号），调入该页时参考。
  2、缺页中断机构
(1) 在指令执行期间产生和处理中断信号。
(2) 一条指令在执行期间可能产生多次缺页中断。



  从下向上执行

  3、地址变换机构：在分页系统地址变换机构的基础上增加了产生和处理缺页中断，从内存中换出一页的功能等。
  
地址变换时先检索快表，寻找要访问的页，如果没有找到页表项则去内存中找，然后根据页表项中的状态位P了解是否已经调入内存，是则将该表的页表项写入快表，否则产生中断请求。


### 请求分页中的内存分配
  1、最小物理块数的确定
  每个进程分配的物理块越少，缺页率上升，进程执行速度降低，为进程分配的物理块小于最小物理块数时，进程无法运行。
  2、内存分配策略（所分配的物理块是固定的，还是可变的）
  1) 固定分配局部置换：为进程分配固定的物理块，进程运行期间不再改变
  2) 可变分配全局置换：凡产生缺页或中断都会分配新的物理块，直到空闲物理块调用完才会从内存中选择调出
  3) 可变分配局部置换：缺页率高时分配新的物理块，缺页率低的时候调出物理块
  3、物理块分配算法
  (1) 平均分配算法：将系统中可分配的物理块平均分给各个进程
  (2) 按比例分配算法：按进程的大小按比例分配物理块
   n个进程，每个进程页面数为Si
  
  每个进程所能分到的物理块数
  
  (3) 考虑优先权的分配算法：一部分按比例地分配给各进程；另一部分则根据各进程的优先权进行分配。  
  实时控制系统可能完全按照优先权分配物理块


### 页面调入策略
：为进程能正常运行，必须将要执行的部分程序和数据所在页面调入内存
  (1) 系统应在何时调入所需页面
  (2) 系统应从何处调入这些页面
  (3) 是如何进行调入的
  1、何时调入页面
  (1) 预调页策略：以预测为基础（记录进程运行时的工作集）
  (2) 请求调页策略：进程运行时发现部分程序和数据不在内存时立即请求并调入内存
  2、从何处调入页面
  (1) 系统拥有足够的对换区空间，这时可以全部从对换区调入所需页面，以提高调页速度。在进程运行之前将与进程有关的文件从文件区拷贝到对换区
  (2) 系统缺少足够的对换区空间：凡是不会被修改的文件都直接从文件区调入，换出时因为它们未被修改，就不用重写到磁盘。在需要修改的部分需要调换到对换区，需要时再调入
  (3) UNIX方式
  3、页面调入过程：程序所要访问的页面未在内存时(存在位为“0”)，便向CPU发出一缺页中断，中断处理程序首先保留CPU环境，分析中断原因后转入缺页中断处理程序。 
  4、缺页率
  进程的逻辑空间为n页
  系统为其分配的内存物理块数为m(m≤n)
  访问页面成功(访问页面在内存中)的次数为S
  访问页面失败(访问页面不在内存中)的次数为F
  页面访问次数为A = S + F
  缺页率f
  


## 页面置换算法

### 最佳置换算法和先进先出置换算法
  1、OPT最佳置换算法
  被淘汰页面将是以后永不使用的，或许是在短时间内不会访问的页面
   7 , 0 , 1 , 2 ,0, 3 , 0, 4 , 2 , 3 , 0 , 3 , 2 ,1 ,2, 0 , 1 , 7 ,0,1

  
  2、FIFO先进先出页面置换算法
  淘汰内存中驻留时间最久的页面



### 最近最久未使用和最少使用置换算法
  1、LRU置换算法的描述
  根据页面调入内存后的使用情况做出决策
  选择最近最久未使用的页面予以淘汰
  
  2、LRU置换算法的硬件支持
  寄存器：移位寄存器  R = Rn-1Rn-2Rn-3 … R2R1R0
  栈：
  
  3、最少使用置换算法
  选择最近时期使用最少的页面作为淘汰页
  关键：选择合适的时间周期T



## “抖动”与工作集
  如果在系统中运行的进程太多，进程在运行中会频繁地发生缺页情况


### 多道程序度与“抖动”
  1、多道程序度与处理机的利用率
  处理机的实际利用率：
  
  2、产生“抖动”的原因：同时在系统中运行的进程太多，分配给每一个进程的物理块太少，导致进程在运行时频繁缺页，系统中排队等待页面调进/调出的进程数目增加。  进程的大部分时间都用于页面的换进/换出，处理机的利用率急剧下降并趋于0


### 工作集
  1、工作集的基本概念
  预测程序在某段时间间隔内要访问哪些页面，并把它们调入内存
  
  2、工作集的定义：用程序的过去某段时间内的行为作为程序在将来某段时间内行为的近似
  


### “抖动”的预防策略
  1、采取局部置换策略：在进程缺页时，只能在分配的内存中置换。  在进程抖动时不会对其他进程产生影响
  2、把工作集算法融入到处理机调度中：驻留页面较多时分配新的作业，页面不足时增加物理块
  3、利用“L=S”准则调节缺页率：L是缺页之间的平均时间，S是平均缺页服务时间。
  若L远比S大，说明很少缺页
  若L比S小，则频繁发生缺页
  L与S接近时，磁盘和处理机可达最大利用率
  4、选择暂停的进程：减少优先级低的进程


## 请求分段存储管理方式

### 请求分段中的硬件支持
  1、请求段表机制
  
  2、缺段中断机制：当运行进程要访问的段未调入内存时，由缺段中断机构产生一缺段中断信号
  
  3、地址变换机制：地址变换时，当所要访问的段不在内存，应先将所缺的段调入内存并修改段表，然后利用段表进行地址变换
  增加了缺段中断的请求及处理等功能
  


### 分段的共享与保护
  1、共享段表
  (1) 共享进程计数count
  (2) 存取控制字段
  (3) 段号
  
  2、分享段的分配与回收
  1) 共享段的分配
  2) 共享段的回收
  3、分段保护
  1) 越界检查
  2) 存取控制检查
  3) 环保护机构
  
  
  
